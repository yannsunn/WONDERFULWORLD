# 🤖 ハイブリッドチャットボット - Gemini無料枠版

WONDERFUL WORLD ウェブサイトの**ハイブリッドAIチャットボット**システムです。

## 🎯 ハイブリッド戦略

### 2段階応答システム

```
ユーザー質問
    ↓
【ステップ1】FAQ検索
    ├─ 適切な回答あり → FAQ応答（無料・高速）
    └─ 回答なし
        ↓
【ステップ2】Gemini AI
    └─ AIで回答生成（無料枠内）
```

### メリット

| 項目 | 説明 |
|------|------|
| 💰 **コスト最適化** | 90%はFAQ、10%のみAI使用 = ほぼ無料 |
| ⚡ **高速応答** | FAQ: <100ms、AI: 1-2s |
| 🎯 **高精度** | FAQ: 100%正確、AI: 柔軟な対応 |
| 📊 **スケーラブル** | Gemini無料枠: 1日1,500リクエスト |

## 📊 Gemini API 無料枠

### 制限

- **1分あたり**: 15リクエスト
- **1日あたり**: 1,500リクエスト
- **月間**: 約45,000リクエスト
- **コスト**: **完全無料** 🎉

### 実装した制限

安全のため、さらに保守的な制限を設定：

- **1分あたり**: 10リクエスト（66%）
- **1日あたり**: 1,000リクエスト（66%）

→ バースト対策とAPI制限回避

## 🏗️ システム構成

### ファイル構造

```
components/
  └── ChatbotHybrid.tsx          # ハイブリッドUI

pages/api/
  └── chat-hybrid.js             # Gemini API統合

data/
  └── chatbot-faq.ts             # FAQデータベース

lib/
  └── chatbot-matcher.ts         # キーワードマッチング
```

### データフロー

```
User Input
    ↓
ChatbotHybrid Component
    ↓
findBestMatch() - キーワードマッチング
    ↓
スコア判定
    ├─ 高スコア → FAQ応答（完了）
    └─ 低スコア
        ↓
    /api/chat-hybrid
        ↓
    レート制限チェック
        ↓
    Gemini API呼び出し
        ↓
    AI応答（完了）
```

## 🚀 セットアップ

### 1. Gemini API Keyの取得

1. [Google AI Studio](https://aistudio.google.com/app/apikey) にアクセス
2. Googleアカウントでログイン
3. 「Create API Key」をクリック
4. APIキーをコピー

### 2. 環境変数の設定

`.env.local`ファイルを作成：

```bash
GEMINI_API_KEY=your_gemini_api_key_here
```

### 3. パッケージのインストール

```bash
npm install @google/generative-ai
```

### 4. 開発サーバー起動

```bash
npm run dev
```

http://localhost:3000 でテスト

## 💡 使用例

### ケース1: FAQ応答（高速・無料）

```
ユーザー: 「WONDERFUL WORLDとは？」
システム: [FAQ検索] → マッチ！
応答: 「WONDERFUL WORLDは、AI技術と美の力で...」
時間: <100ms
コスト: ¥0
バッジ: 🟢 FAQ
```

### ケース2: AI応答（柔軟・無料枠）

```
ユーザー: 「会社設立年月日を教えてください」
システム: [FAQ検索] → マッチなし → [Gemini API]
応答: 「WONDERFUL WORLDの会社情報については...」
時間: 1-2s
コスト: ¥0（無料枠内）
バッジ: 🔵 AI
```

### ケース3: レート制限

```
ユーザー: （短時間に多数のリクエスト）
システム: [レート制限チェック] → 制限超過
応答: 「1分間のリクエスト制限に達しました...」
フォールバック: FAQ応答に切り替え
```

## 🔧 カスタマイズ

### レート制限の調整

`pages/api/chat-hybrid.js`:

```javascript
const RATE_LIMIT = {
  perMinute: 10,  // 変更可能（最大15）
  perDay: 1000    // 変更可能（最大1500）
};
```

### FAQスコア閾値の調整

`components/ChatbotHybrid.tsx`:

```typescript
const FAQ_SCORE_THRESHOLD = 5; // この値以上ならFAQ、以下ならAI
```

- 値を上げる → AI使用増加（柔軟性↑、コスト↑）
- 値を下げる → FAQ使用増加（コスト↓、柔軟性↓）

### Geminiモデルの変更

`pages/api/chat-hybrid.js`:

```javascript
const model = genAI.getGenerativeModel({
  model: 'gemini-1.5-flash'  // 高速・軽量（推奨）
  // model: 'gemini-1.5-pro' // 高性能・低速
});
```

### 会話履歴の長さ

```typescript
const conversationHistory = messages
  .slice(-6) // 直近3往復（変更可能）
  .map(msg => ({ role: msg.role, content: msg.content }));
```

## 📊 コスト分析

### 想定使用量

- **1日あたりの訪問者**: 1,000人
- **チャット利用率**: 10% = 100人
- **1人あたりの質問**: 3問 = 300問

### FAQ vs AI 比率

```
300問 ÷ 2つの応答タイプ
├─ FAQ応答: 270問（90%） → コスト: ¥0
└─ AI応答: 30問（10%） → コスト: ¥0（無料枠内）

月間合計: 9,000問
├─ FAQ: 8,100問
└─ AI: 900問（無料枠: 45,000問）

→ 月額コスト: ¥0 🎉
```

### スケーラビリティ

無料枠の限界:

- **1日**: 1,000 AIリクエスト / 1,000人訪問 = 1問/人
- **月間**: 30,000 AIリクエスト

→ 月間3万人まで無料対応可能！

## 🛡️ セキュリティ機能

### レート制限

- クライアントIPベースの制限
- 1分・1日の2段階制限
- メモリ内カウンター（軽量）

### フォールバック機能

1. **API Key未設定**: FAQ応答に切り替え
2. **レート制限超過**: FAQ応答に切り替え
3. **APIエラー**: FAQ応答に切り替え

### コンテンツフィルター

Geminiのシステムコンテキストで制限：

- WONDERFUL WORLD関連のみ回答
- 技術情報・個人情報は回答拒否
- 簡潔な回答（3-5文）

## 📈 モニタリング

### APIレスポンスの確認

ブラウザコンソール（F12）でログ確認：

```javascript
{
  message: "...",
  source: "gemini",
  usage: {
    perMinuteRemaining: 9,
    perDayRemaining: 999
  }
}
```

### 使用状況の追跡

本番環境では以下を推奨：

- **Redis**: レート制限の永続化
- **Analytics**: FAQ vs AI比率の追跡
- **Logs**: Gemini API使用量の監視

## 🧪 テスト

### FAQ応答のテスト

```
「WONDERFUL WORLDとは？」
→ 期待: FAQ応答、バッジ: 🟢 FAQ

「所属モデルは？」
→ 期待: FAQ応答、バッジ: 🟢 FAQ
```

### AI応答のテスト

```
「プロジェクトの将来的な展望は？」
→ 期待: AI応答、バッジ: 🔵 AI

「他のミスコンテストとの違いは？」
→ 期待: AI応答、バッジ: 🔵 AI
```

### エラーハンドリングのテスト

```
API Key未設定の状態で質問
→ 期待: FAQ応答にフォールバック

短時間に11回質問
→ 期待: レート制限メッセージ
```

## 🔄 メンテナンス

### 日次タスク

- [ ] Gemini API使用量の確認
- [ ] エラーログの確認

### 週次タスク

- [ ] FAQ vs AI比率の分析
- [ ] よくAIに回答させている質問をFAQに追加

### 月次タスク

- [ ] 無料枠の使用率確認
- [ ] レート制限の調整検討
- [ ] FAQデータベースの拡充

## 📚 トラブルシューティング

### 「API設定エラー」が表示される

**原因**: `GEMINI_API_KEY`が未設定

**解決策**:
1. `.env.local`を作成
2. API Keyを設定
3. サーバー再起動

### 「リクエスト制限に達しました」

**原因**: レート制限超過

**対策**:
1. FAQ応答に一時的に切り替わる
2. 1分後に再度試す
3. レート制限を緩和（推奨せず）

### AI応答が遅い

**原因**: Gemini APIのレイテンシ

**対策**:
1. FAQ応答を優先（スコア閾値を上げる）
2. Gemini 1.5 Flash使用（現在の設定）
3. 会話履歴を短縮

### FAQ応答が多すぎる/少なすぎる

**調整**: `FAQ_SCORE_THRESHOLD`の変更

```typescript
// AI使用を増やしたい場合
const FAQ_SCORE_THRESHOLD = 8; // 5 → 8

// FAQ使用を増やしたい場合
const FAQ_SCORE_THRESHOLD = 3; // 5 → 3
```

## 💡 今後の改善案

### Phase 2: エンハンスメント
- [ ] Redis導入（レート制限の永続化）
- [ ] Analytics統合（FAQ vs AI比率の可視化）
- [ ] FAQの自動学習（AI回答をFAQに変換）

### Phase 3: 高度な機能
- [ ] ユーザーフィードバック収集
- [ ] 回答品質の評価システム
- [ ] A/Bテスト（FAQ閾値の最適化）

### Phase 4: スケーリング
- [ ] 有料プラン移行の検討（月3万人超えた場合）
- [ ] CDN統合
- [ ] マルチリージョン対応

## 🆚 システム比較

| 項目 | 完全FAQ | ハイブリッド | 完全AI |
|------|---------|-------------|--------|
| 月額コスト | ¥0 | ¥0 | $50-200 |
| 応答速度 | <100ms | 100ms-2s | 1-3s |
| 柔軟性 | 低 | **高** | 最高 |
| メンテナンス | 多 | **中** | 少 |
| スケール | ∞ | **月3万人** | ∞ |
| **推奨** | 小規模 | **中規模** | 大規模 |

## 📞 サポート

質問・問題がある場合:

1. このドキュメントを確認
2. `CHATBOT_FREE.md`（FAQ詳細）を確認
3. GitHub Issuesで報告
4. お問い合わせページから連絡

---

**バージョン**: 3.0.0 (Hybrid/Gemini)
**最終更新**: 2025-10-15
**コスト**: ¥0/月（無料枠内） 🎉
**推奨**: 月間訪問者 3万人まで
