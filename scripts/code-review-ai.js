/**
 * AI-Powered Code Review Script
 *
 * OpenAI API (GPT-4) ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½
 *
 * ä½¿ç”¨æ–¹æ³•:
 * 1. .env.local ã« OPENAI_API_KEY ã‚’è¨­å®š
 * 2. node scripts/code-review-ai.js ã‚’å®Ÿè¡Œ
 */

const fs = require('fs');
const path = require('path');

// .env.local ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
require('dotenv').config({ path: '.env.local' });

const { OpenAI } = require('openai');

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³
const TARGET_PATTERNS = [
  'components/**/*.tsx',
  'app/**/*.tsx',
  'lib/**/*.ts',
  'data/**/*.ts',
];

// é™¤å¤–ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
const EXCLUDE_DIRS = ['node_modules', '.next', 'dist', 'build'];

/**
 * ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
 */
function scanDirectory(dir, fileList = []) {
  const files = fs.readdirSync(dir);

  files.forEach(file => {
    const filePath = path.join(dir, file);
    const stat = fs.statSync(filePath);

    if (stat.isDirectory()) {
      if (!EXCLUDE_DIRS.includes(file)) {
        scanDirectory(filePath, fileList);
      }
    } else if (file.endsWith('.tsx') || file.endsWith('.ts')) {
      fileList.push(filePath);
    }
  });

  return fileList;
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã‚³ãƒ¼ãƒ‰å†…å®¹ã‚’å–å¾—
 */
function readFileContent(filePath) {
  return fs.readFileSync(filePath, 'utf-8');
}

/**
 * GPT-4ã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½
 */
async function reviewCode(files) {
  console.log(`ğŸ“‹ ${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¾ã™...\n`);

  // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’çµåˆï¼ˆãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«æ³¨æ„ï¼‰
  const codeSnippets = files.slice(0, 10).map(file => {
    const content = readFileContent(file);
    return `\n### ${file}\n\`\`\`typescript\n${content.slice(0, 1000)}\n\`\`\``;
  }).join('\n');

  const prompt = `
ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®Next.js 14ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
1. **TypeScriptå‹å®‰å…¨æ€§**: anyå‹ã®ä½¿ç”¨ã€å‹å®šç¾©ã®ä¸è¶³
2. **Next.js 14ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**: App Routerã€Server/Client Componentã€Dynamic Import
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ä¸è¦ãªre-renderã€ãƒ¡ãƒ¢åŒ–ã®æ©Ÿä¼šã€ç”»åƒæœ€é©åŒ–
4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: XSSã€CSRFã€æ©Ÿå¯†æƒ…å ±ã®æ‰±ã„
5. **ã‚³ãƒ¼ãƒ‰ã®ä¿å®ˆæ€§**: å¯èª­æ€§ã€å‘½åè¦å‰‡ã€ã‚³ãƒ¡ãƒ³ãƒˆ

## ã‚³ãƒ¼ãƒ‰
${codeSnippets}

## å‡ºåŠ›å½¢å¼
### ğŸŸ¢ è‰¯ã„ç‚¹
- ç®‡æ¡æ›¸ãã§3-5ç‚¹

### ğŸŸ¡ æ”¹å–„æ¨å¥¨
- ç®‡æ¡æ›¸ãã§3-5ç‚¹ï¼ˆå„ªå…ˆåº¦é †ï¼‰

### ğŸ”´ é‡å¤§ãªå•é¡Œ
- ç®‡æ¡æ›¸ãã§å•é¡Œç‚¹ï¼ˆè©²å½“ã™ã‚‹å ´åˆã®ã¿ï¼‰

### ğŸ“Š ç·åˆè©•ä¾¡
- Grade: A/B/C/D/F
- Score: X/100
- ã‚³ãƒ¡ãƒ³ãƒˆ: ç·è©•ï¼ˆ2-3æ–‡ï¼‰
`;

  console.log('ğŸ¤– GPT-4ã«ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ä¸­...\n');

  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [{ role: 'user', content: prompt }],
    max_tokens: 2000,
    temperature: 0.3,
  });

  const review = response.choices[0].message.content;

  console.log('âœ… ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ï¼\n');
  console.log('='.repeat(80));
  console.log(review);
  console.log('='.repeat(80));

  // ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
  const outputPath = path.join(__dirname, '..', 'docs', 'AI_CODE_REVIEW.md');
  const markdown = `# AI Code Review Report

**Date**: ${new Date().toLocaleDateString('ja-JP')}
**Model**: GPT-4
**Files Reviewed**: ${files.length}

${review}

---
*Generated by OpenAI GPT-4*
`;

  fs.writeFileSync(outputPath, markdown, 'utf-8');
  console.log(`\nğŸ“„ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${outputPath}`);
}

/**
 * ãƒ¡ã‚¤ãƒ³å‡¦ç†
 */
async function main() {
  try {
    if (!process.env.OPENAI_API_KEY) {
      console.error('âŒ ã‚¨ãƒ©ãƒ¼: OPENAI_API_KEY ãŒ .env.local ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      console.log('\nè¨­å®šæ–¹æ³•:');
      console.log('1. https://platform.openai.com/api-keys ã§APIã‚­ãƒ¼ã‚’å–å¾—');
      console.log('2. .env.local ã« OPENAI_API_KEY=sk-... ã‚’è¿½åŠ ');
      process.exit(1);
    }

    console.log('ğŸ” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...\n');

    const projectRoot = path.join(__dirname, '..');
    const files = scanDirectory(projectRoot);

    console.log(`âœ… ${files.length}å€‹ã®TypeScript/TSXãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º\n`);

    await reviewCode(files);

  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error.message);
    process.exit(1);
  }
}

main();
